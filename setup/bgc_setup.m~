%%% 
%%% bgc_setup.m
%%%
%%% Sets biogeochemical parameters to be used in MAMEBUS in the NPZD Model
%%%
%%% The initial values will be output as a matrix, and biogeochemical
%%% parameters are output as a vector to be read into the model. 
%%%


function [params, bgc_init, nbgc, lp, lz, NP, NZ, bgcRates] = bgc_setup(ZZ_tr,Nx,Nz,modeltype,MP,MZ,data_dir)


% light and temperature parameters
qsw = 340; % W/m^2
kw = 0.04; % light attenuation of water
kc = 0.01; % light attenuation of phytoplankton (nitrogen units)
Tref = 10; % deg C
r = 0.05;  % temperature dependence

% phytoplankton parameters
au = 2.6; %1/d
bu = -0.45;
kn = 0.1; % mmol N/m^3
mp = 0.2; % mortality as a fraction of uptake

% zooplankton parameters
ag = 26;
bg = -0.4;
lambda = 1.0/3.0; % grazing efficiency
kp = 3; % mmol N/m^3
bl = 0.5;
al = 0.65;
delta_x = 0.25; % width of grazing profile

%%% Depending on the model type, return size grid and the data grid. 
[lp, lz, NP, NZ, bgcRates, idxUptake, idxSat, idxGrazing, idxPredPrey, zeta] ...
    = buildSizeGrid(modeltype,MP,MZ,delta_x,data_dir, au, bu, kn, ag, bg, al, bl ,lambda);

nbgc = max(NP,NZ);



% detrital parameters
r_remin = 0.04; % 1/d
wsink = 10; % m/d


%%% save all parameters
params = [qsw, kw, kc, Tref, r, ...
            mp, ...
            lambda, kp, delta_x, zeta ...
            r_remin, wsink ...
            idxUptake, idxSat, idxGrazing, idxPredPrey];
        
nbgc = length(params);


%%% Create initial conditions
Pcline = 75;
Pmax = 0.1; % mmol/m3
Dmax = 0;

euph_init = Pmax*(tanh(ZZ_tr/Pcline))+0.1;
% euph_init = 0.1*ones(Nx,Nz);

%%% Initial nitrate profile (Hyperbolic)
Nmax = 30; %%% Maximum concentration of nutrient at the ocean bed
Ncline = 80; % Approximate guess of the depth of the nutracline



bgc_init(:,:,1) = -Nmax*tanh(ZZ_tr/Ncline);
bgc_init(:,:,2:NP+2) = euph_init;
bgc_init(:,:,) = 0.1*euph_init;
bgc_init(:,:,4) = Dmax*zeros(Nx,Nz);
end
